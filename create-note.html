<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Create Promissory Note — TrustLend</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <h1 class="text-2xl font-bold mb-6">Create Promissory Note</h1>

    <!-- Progress dots -->
    <div class="flex items-center gap-3 mb-6" id="progressDots">
      <div class="w-2.5 h-2.5 rounded-full bg-blue-600"></div>
      <div class="w-2.5 h-2.5 rounded-full bg-gray-300"></div>
      <div class="w-2.5 h-2.5 rounded-full bg-gray-300"></div>
      <div class="w-2.5 h-2.5 rounded-full bg-gray-300"></div>
      <div class="w-2.5 h-2.5 rounded-full bg-gray-300"></div>
      <div class="w-2.5 h-2.5 rounded-full bg-gray-300"></div>
      <div class="w-2.5 h-2.5 rounded-full bg-gray-300"></div>
    </div>

    <!-- STEP 1: Loan Details -->
    <section id="step-1" class="form-step">
      <h2 class="text-xl font-semibold mb-4">1. Loan Details</h2>
      <div class="grid md:grid-cols-2 gap-6">
        <div class="space-y-3">
          <label class="block">
            <span class="text-sm">Loan Amount</span>
            <input id="loanAmount" type="number" min="1" class="mt-1 w-full border rounded p-2" placeholder="e.g., 1100" />
          </label>

          <label class="block">
            <span class="text-sm">Loan Start Date</span>
            <input id="loanStartDate" type="date" class="mt-1 w-full border rounded p-2" />
          </label>

          <label class="block">
            <span class="text-sm">Loan Term</span>
            <select id="loanTerm" class="mt-1 w-full border rounded p-2">
              <option value="">Select Term</option>
              <option data-months="1">1 month</option>
              <option data-months="3">3 months</option>
              <option data-months="6">6 months</option>
              <option data-months="9">9 months</option>
              <option data-months="12">12 months</option>
              <option data-months="18">18 months</option>
              <option data-months="24">24 months</option>
            </select>
          </label>

          <label class="block">
            <span class="text-sm">Payment Schedule</span>
            <select id="paymentSchedule" class="mt-1 w-full border rounded p-2">
              <option value="">Select Schedule</option>
              <option value="weekly">Weekly</option>
              <option value="biweekly">Bi-weekly</option>
              <option value="monthly">Monthly</option>
              <option value="lump">Lump Sum</option>
            </select>
          </label>

          <div class="grid grid-cols-2 gap-3">
            <label class="block">
              <span class="text-sm">First Payment Due</span>
              <input id="firstPaymentDueDate" type="date" class="mt-1 w-full border rounded p-2" />
            </label>
            <label class="block">
              <span class="text-sm">Final Payment Date</span>
              <input id="finalPaymentDate" type="date" class="mt-1 w-full border rounded p-2" />
            </label>
          </div>
        </div>

        <aside class="border rounded-lg p-4 bg-white">
          <h3 class="font-semibold mb-2">Preview</h3>
          <dl class="text-sm space-y-1">
            <div class="flex justify-between"><dt>Amount</dt><dd id="pvAmount">—</dd></div>
            <div class="flex justify-between"><dt>Start</dt><dd id="pvStart">—</dd></div>
            <div class="flex justify-between"><dt>Term</dt><dd id="pvTerm">—</dd></div>
            <div class="flex justify-between"><dt>Schedule</dt><dd id="pvSchedule">—</dd></div>
            <div class="flex justify-between"><dt>First Due</dt><dd id="pvFirst">—</dd></div>
            <div class="flex justify-between"><dt>Final Date</dt><dd id="pvFinal">—</dd></div>
          </dl>
          <p class="text-xs text-gray-500 mt-3"><strong>Installments:</strong> <span id="installmentCount"></span><span id="installmentSummary" class="ml-2"></span></p>
        </aside>
      </div>

      <div class="mt-6 flex justify-end">
        <button class="btn-next bg-blue-600 text-white px-4 py-2 rounded">Next</button>
      </div>
    </section>

    <!-- STEP 2: Parties -->
    <section id="step-2" class="form-step hidden">
      <h2 class="text-xl font-semibold mb-4">2. Parties</h2>
      <div class="grid md:grid-cols-2 gap-6">
        <div class="space-y-3">
          <h3 class="font-medium">Lender</h3>
          <input id="lenderName"  class="w-full border rounded p-2" placeholder="Full name" />
          <input id="lenderEmail" class="w-full border rounded p-2" placeholder="Email" />
          <input id="lenderPhone" class="w-full border rounded p-2" placeholder="Phone" />
        </div>
        <div class="space-y-3">
          <h3 class="font-medium">Borrower</h3>
          <input id="borrowerName"  class="w-full border rounded p-2" placeholder="Full name" />
          <input id="borrowerEmail" class="w-full border rounded p-2" placeholder="Email" />
          <input id="borrowerPhone" class="w-full border rounded p-2" placeholder="Phone" />
        </div>
      </div>
      <div class="mt-6 flex justify-between">
        <button class="btn-prev border px-4 py-2 rounded">Previous</button>
        <button class="btn-next bg-blue-600 text-white px-4 py-2 rounded">Next</button>
      </div>
    </section>

    <!-- STEP 3: Options & Add-Ons -->
    <section id="step-3" class="form-step hidden">
      <h2 class="text-xl font-semibold mb-4">3. Options & Add-Ons</h2>

      <div class="mb-4 p-3 border rounded bg-white">
        <div class="flex items-center justify-between">
          <div>
            <div class="font-semibold">Plan</div>
            <div id="planName" class="text-sm text-gray-600">Essential Protection</div>
          </div>
          <div class="text-right">
            <div id="planPriceDisplay" class="text-2xl font-bold text-blue-600">$14.99</div>
            <div class="text-xs text-gray-500">One-time fee</div>
          </div>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <div class="p-3 border rounded bg-white">
          <label class="flex items-center gap-2">
            <input type="checkbox" id="enableLateFee" />
            <span>Include late-fee clause</span>
          </label>
          <input id="lateFeeText" class="mt-2 w-full border rounded p-2" placeholder="Example: $25 after 7 days late" style="display:none" />
        </div>

        <div class="p-3 border rounded bg-white">
          <label class="flex items-center gap-2">
            <input type="checkbox" id="enableWitness" />
            <span>Add witness/observer</span>
          </label>
          <div id="witnessFields" class="mt-2 hidden">
            <input id="witnessName" class="w-full border rounded p-2 mb-2" placeholder="Witness full name" />
            <canvas id="witnessSignature" width="300" height="120" class="border rounded bg-white"></canvas>
          </div>
        </div>

        <div class="p-3 border rounded bg-white">
          <label class="block mb-1">Collateral (optional)</label>
          <textarea id="collateralText" class="w-full border rounded p-2" placeholder="Describe collateral, if any"></textarea>
        </div>

        <div class="p-3 border rounded bg-white">
          <div class="text-sm"><strong>Contract ID:</strong> <span id="contractId"></span></div>
          <div id="qrWrap" class="mt-2"></div>
          <button id="downloadICS" type="button" class="mt-2 text-blue-600 underline text-sm">Add due date to calendar</button>
        </div>
      </div>

      <div class="mt-6 flex justify-between">
        <button class="btn-prev border px-4 py-2 rounded">Previous</button>
        <button class="btn-next bg-blue-600 text-white px-4 py-2 rounded">Next</button>
      </div>
    </section>

    <!-- STEP 4: Review -->
    <section id="step-4" class="form-step hidden">
      <h2 class="text-xl font-semibold mb-4">4. Review</h2>
      <div class="grid md:grid-cols-2 gap-6">
        <div class="space-y-3">
          <div class="p-3 border rounded bg-white">
            <h3 class="font-medium mb-2">Confirm details</h3>
            <ul class="text-sm text-gray-700 space-y-1">
              <li>Loan amount: <span id="rvAmount">—</span></li>
              <li>Term & schedule: <span id="rvTermSched">—</span></li>
              <li>First due / Final: <span id="rvDates">—</span></li>
              <li>Parties: <span id="rvParties">—</span></li>
              <li>Add-ons: <span id="rvAddons">—</span></li>
            </ul>
            <label class="flex items-center gap-2 mt-3">
              <input type="checkbox" id="confirmReview" />
              <span>I confirm the details above are accurate.</span>
            </label>
          </div>
        </div>
        <aside class="p-3 border rounded bg-white">
          <h3 class="font-medium mb-2">Contract preview</h3>
          <p class="text-sm text-gray-600">Your 1–2 page PDF will include an integrity hash footer and any optional clauses you selected.</p>
        </aside>
      </div>
      <div class="mt-6 flex justify-between">
        <button class="btn-prev border px-4 py-2 rounded">Previous</button>
        <button id="goSign" class="btn-next bg-blue-600 text-white px-4 py-2 rounded" disabled>Proceed to Sign</button>
      </div>
    </section>

    <!-- STEP 5: Sign -->
    <section id="step-5" class="form-step hidden">
      <h2 class="text-xl font-semibold mb-4">5. Sign</h2>
      <p class="text-sm text-gray-700 mb-3">ESIGN consent and timestamps will be recorded for both parties.</p>
      <div class="grid md:grid-cols-2 gap-6">
        <div class="p-3 border rounded bg-white">
          <h3 class="font-medium mb-2">Lender Signature</h3>
          <canvas id="sigLender" width="500" height="160" class="border rounded bg-white"></canvas>
        </div>
        <div class="p-3 border rounded bg-white">
          <h3 class="font-medium mb-2">Borrower Signature</h3>
          <canvas id="sigBorrower" width="500" height="160" class="border rounded bg-white"></canvas>
        </div>
      </div>
      <div class="mt-6 flex justify-between">
        <button class="btn-prev border px-4 py-2 rounded">Previous</button>
        <button class="btn-next bg-blue-600 text-white px-4 py-2 rounded">Next</button>
      </div>
    </section>

    <!-- STEP 6: Pay & Generate -->
    <section id="step-6" class="form-step hidden">
      <h2 class="text-xl font-semibold mb-4">6. Pay & Generate</h2>
      <p class="text-sm text-gray-700 mb-3">One-time fee for <strong id="payPlanName">Essential Protection</strong>:
        <strong id="payPlanPrice">$14.99</strong></p>
      <div class="p-3 border rounded bg-white">
        <p class="text-sm text-gray-600">Stripe Elements placeholder here.</p>
      </div>
      <div class="mt-6 flex justify-between">
        <button class="btn-prev border px-4 py-2 rounded">Previous</button>
        <button id="btnGenerate" class="bg-blue-600 text-white px-4 py-2 rounded">Pay & Generate PDF</button>
      </div>
    </section>

    <!-- STEP 7: Confirmation -->
    <section id="step-7" class="form-step hidden">
      <h2 class="text-xl font-semibold mb-4">7. Confirmation</h2>
      <p class="text-sm text-gray-700">Your contract is ready.</p>
      <ul class="list-disc pl-6 text-sm text-gray-700">
        <li><a id="downloadPdfLink" class="text-blue-600 underline" href="#">Download PDF</a></li>
        <li><span id="finalContractId"></span> (scan QR on PDF to reopen)</li>
      </ul>
      <div class="mt-6">
        <a href="dashboard.html" class="bg-gray-900 text-white px-4 py-2 rounded">Go to Dashboard</a>
      </div>
    </section>
  </main>

  <!-- Logic -->
  <script type="module">
    import { TL_PLAN_NAME, TL_PLAN_PRICE } from './js/constants.js';
    import { applyPlanToPreview, parseISO, iso, addMonths, addDays } from './js/preview-hooks.js';

    // Stepper
    const steps = Array.from(document.querySelectorAll('.form-step'));
    const dots  = Array.from(document.querySelectorAll('#progressDots > div'));
    let idx = 0;
    function show(i){
      idx = Math.max(0, Math.min(i, steps.length-1));
      steps.forEach((s,n)=>s.classList.toggle('hidden', n!==idx));
      dots.forEach((d,n)=>{
        d.classList.toggle('bg-blue-600', n===idx);
        d.classList.toggle('bg-gray-300', n!==idx);
      });
      window.scrollTo({top:0,behavior:'smooth'});
      syncPlanEverywhere();
      hydrateReview();
    }
    document.querySelectorAll('.btn-next').forEach(b=>b.addEventListener('click',e=>{e.preventDefault();show(idx+1);}));
    document.querySelectorAll('.btn-prev').forEach(b=>b.addEventListener('click',e=>{e.preventDefault();show(idx-1);}));
    show(0);

    // Centralize plan price/name
    function syncPlanEverywhere(){
      applyPlanToPreview();
      const payName  = document.getElementById('payPlanName');
      const payPrice = document.getElementById('payPlanPrice');
      if (payName)  payName.textContent  = TL_PLAN_NAME;
      if (payPrice) payPrice.textContent = `$${TL_PLAN_PRICE.toFixed(2)}`;
    }
    syncPlanEverywhere();

    // Dates + preview
    const start = document.getElementById('loanStartDate');
    const term  = document.getElementById('loanTerm');
    const sched = document.getElementById('paymentSchedule');
    const first = document.getElementById('firstPaymentDueDate');
    const final = document.getElementById('finalPaymentDate');

    function monthsFromTerm(){
      const opt = term.options[term.selectedIndex];
      const m   = opt?.dataset?.months ? parseInt(opt.dataset.months,10) : parseInt(opt?.value||opt?.textContent||'0',10);
      return isNaN(m) ? 0 : m;
    }
    function recomputeDates(){
      const s = start && start.value ? parseISO(start.value) : null;
      if (!s) return;
      const m = monthsFromTerm();
      if (final && m>0) final.value = iso(addMonths(s, m));
      if (first && sched){
        const v = sched.value;
        let due = null;
        if (v==='weekly')   due = addDays(s,7);
        else if (v==='biweekly') due = addDays(s,14);
        else if (v==='monthly')  due = addMonths(s,1);
        else if (v==='lump')     due = final && final.value ? parseISO(final.value) : addMonths(s, m||1);
        if (due) first.value = iso(due);
      }
      // Preview
      document.getElementById('pvAmount').textContent   = document.getElementById('loanAmount').value || '—';
      document.getElementById('pvStart').textContent    = start.value || '—';
      document.getElementById('pvTerm').textContent     = term.selectedOptions[0]?.textContent || '—';
      document.getElementById('pvSchedule').textContent = sched.value || '—';
      document.getElementById('pvFirst').textContent    = first.value || '—';
      document.getElementById('pvFinal').textContent    = final.value || '—';

      // Installments (summary only)
      const countEl = document.getElementById('installmentCount');
      const sumEl   = document.getElementById('installmentSummary');
      let count = 0;
      if (sched.value==='weekly'   && m>0) count = m*4;
      else if (sched.value==='biweekly' && m>0) count = m*2;
      else if (sched.value==='monthly'  && m>0) count = m;
      else if (sched.value==='lump')     count = 1;
      if (countEl) countEl.textContent = count ? `${count} installment${count>1?'s':''}` : '';
      if (sumEl) {
        const nice = sched.value ? (sched.value==='lump'?'Lump sum':sched.value[0].toUpperCase()+sched.value.slice(1)) : '';
        sumEl.textContent = count ? `• ${nice}${first && first.value?` • First due ${first.value}`:''}` : '';
      }
    }
    [start, term, sched, first, final, document.getElementById('loanAmount')].forEach(el=>el&&el.addEventListener('change',recomputeDates));
    recomputeDates();

    // Add-ons toggles
    const lateToggle = document.getElementById('enableLateFee');
    const lateText   = document.getElementById('lateFeeText');
    lateToggle?.addEventListener('change', ()=> lateText.style.display = lateToggle.checked ? 'block' : 'none');
    const witToggle  = document.getElementById('enableWitness');
    const witFields  = document.getElementById('witnessFields');
    witToggle?.addEventListener('change', ()=> witFields.classList.toggle('hidden', !witToggle.checked));

    // Contract ID + QR + ICS
    const contractId = 'TL-' + new Date().toISOString().slice(0,10).replace(/-/g,'') + '-' + Math.random().toString(36).slice(2,6).toUpperCase();
    document.getElementById('contractId').textContent = contractId;
    import('https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js').then(()=>{
      const url  = location.origin + '/contracts.html?id=' + encodeURIComponent(contractId);
      const wrap = document.getElementById('qrWrap');
      if (wrap && window.QRCode){
        window.QRCode.toCanvas(document.createElement('canvas'), url, {width:96}, (err, canvas)=>{ if(!err) wrap.appendChild(canvas); });
      }
    });
    document.getElementById('downloadICS').addEventListener('click', ()=>{
      const due = first?.value; if(!due){ alert('Set a first payment date first.'); return; }
      const dt  = due.replace(/-/g,'')+'T090000Z';
      const ics = [
        'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//TrustLend//EN','CALSCALE:GREGORIAN',
        'BEGIN:VEVENT', `UID:${contractId}@trustlend`, `DTSTAMP:${dt}`, `DTSTART:${dt}`,
        `SUMMARY:Payment due for ${contractId}`, 'DESCRIPTION:Friendly reminder generated by TrustLend',
        'END:VEVENT','END:VCALENDAR'
      ].join('\r\n');
      const blob = new Blob([ics], {type:'text/calendar;charset=utf-8;'});
      const a    = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${contractId}-due.ics`; a.click();
    });

    // Review gate
    const confirmReview = document.getElementById('confirmReview');
    const goSign        = document.getElementById('goSign');
    confirmReview?.addEventListener('change', ()=> { goSign.disabled = !confirmReview.checked; });

    // Build payload for Documint
    window.buildPdfPayload = function(){
      const payload = {};
      payload.planName  = TL_PLAN_NAME;
      payload.planPrice = TL_PLAN_PRICE;
      payload.loanAmount = document.getElementById('loanAmount').value;
      payload.loanStartDate = start.value;
      payload.loanTerm = term.selectedOptions[0]?.textContent || term.value;
      payload.paymentSchedule = sched.value;
      payload.firstPaymentDueDate = first.value;
      payload.finalPaymentDate = final.value;

      payload.lender = {
        name:  document.getElementById('lenderName').value,
        email: document.getElementById('lenderEmail').value,
        phone: document.getElementById('lenderPhone').value,
      };
      payload.borrower = {
        name:  document.getElementById('borrowerName').value,
        email: document.getElementById('borrowerEmail').value,
        phone: document.getElementById('borrowerPhone').value,
      };

      payload.lateFeeClause = lateToggle?.checked ? (lateText.value || '').trim() : '';
      payload.witness = {
        name: document.getElementById('witnessName')?.value?.trim() || '',
        signatureDataUrl: (()=>{ const c=document.getElementById('witnessSignature'); try { return c ? c.toDataURL('image/png') : ''; } catch { return ''; } })()
      };
      payload.collateral = document.getElementById('collateralText')?.value?.trim() || '';
      payload.contractId = contractId;
      payload.installmentSummary = document.getElementById('installmentSummary')?.textContent?.trim() || '';
      return payload;
    };

    // Mock: generate → confirmation
    document.getElementById('btnGenerate').addEventListener('click', ()=>{
      document.getElementById('finalContractId').textContent = 'Contract ID: ' + contractId;
      show(6);
    });

    // Hydrate review snapshot
    function hydrateReview(){
      if (idx !== 3) return; // step 4
      document.getElementById('rvAmount').textContent    = document.getElementById('loanAmount').value || '—';
      const termText  = term.selectedOptions[0]?.textContent || '';
      const schedText = sched.value || '';
      document.getElementById('rvTermSched').textContent = `${termText} • ${schedText || '—'}`;
      document.getElementById('rvDates').textContent     = `${first.value || '—'} • ${final.value || '—'}`;
      document.getElementById('rvParties').textContent   = `${document.getElementById('lenderName').value || 'Lender'} ↔ ${document.getElementById('borrowerName').value || 'Borrower'}`;
      const extras = [];
      if (document.getElementById('enableLateFee')?.checked) extras.push('Late fee');
      if (document.getElementById('witnessName')?.value)     extras.push('Witness');
      if (document.getElementById('collateralText')?.value)  extras.push('Collateral');
      extras.push('Contract ID');
      document.getElementById('rvAddons').textContent = extras.join(', ');
    }
  </script>
</body>
</html>
