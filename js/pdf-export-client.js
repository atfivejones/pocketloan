const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
async function cap(sel){const c=document.querySelector(sel);if(!c)return null;return{dataUrl:c.toDataURL('image/png'),at:new Date().toISOString()};}
function clr(sel){const c=document.querySelector(sel);if(!c)return;const x=c.getContext('2d');x.clearRect(0,0,c.width,c.height);}
async function gather(){const amt=parseFloat($('#amount').value.replace(/[^0-9.]/g,''))||0, term=parseInt($('#loanTerm').value||'0',10)||0, sch=$('#schedule').value, start=$('#startDate').value, final=$('#finalDate').value, st=$('#state').value, co=$('#county').value, g=parseInt($('#graceDays').value||'5',10); const lender={name:$('#lenderName').value,email:$('#lenderEmail').value}, borrower={name:$('#borrowerName').value,email:$('#borrowerEmail').value}; const l=await cap('#lenderSig'), b=await cap('#borrowerSig'); const cnt=sch==='monthly'?term:sch==='biweekly'?term*2:sch==='weekly'?term*4:1; const noteId=`TL-${Date.now().toString(36).toUpperCase()}`; return{plan:($('#plan')?.value||'essential').toLowerCase(), data:{loan:{amount:amt,schedule:sch,termMonths:term,installmentCount:cnt,startDate:start,finalDate:final,graceDays:g}, parties:{lender,borrower}, venue:{state:st,county:co}, signatures:{lender:{dataUrl:l?.dataUrl,at:l?.at},borrower:{dataUrl:b?.dataUrl,at:b?.at}}, audit:{noteId,createdAt:new Date().toISOString()}, style:{friendly:false,business:true,protective:false}}};}
async function gen(){const btn=$('#generatePdfBtn'); btn.disabled=true; btn.textContent='Generating…'; try{const payload=await gather(); const r=await fetch('/api/documint',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); const j=await r.json(); if(!r.ok||!j.ok) throw new Error(j.error||'Export failed'); $('#pdfLink').innerHTML=j.downloadUrl?`<a class="btn" href="${j.downloadUrl}" target="_blank" rel="noopener">Open PDF</a>`:'<span class="warn">PDF created, but no download URL.</span>'; $('#auditBlock').textContent=`SHA-256: ${j.audit?.pdfSha256||'n/a'} · Server UTC: ${j.audit?.serverTimestamp||'n/a'}`; }catch(e){ alert('PDF export failed: '+e.message);} finally{btn.disabled=false; btn.textContent='Generate PDF';}}
document.addEventListener('DOMContentLoaded',()=>{const b=$('#generatePdfBtn'); if(b) b.addEventListener('click', gen); document.querySelectorAll('.clearL').forEach(x=>x.addEventListener('click',()=>clr('#lenderSig'))); document.querySelectorAll('.clearB').forEach(x=>x.addEventListener('click',()=>clr('#borrowerSig')));});